<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>R√©initialiser le mot de passe ‚Äî Salvi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{ --bg:#0f172a; --panel:#fff; --text:#0f172a; --brand:#0ea5e9; --ok:#16a34a; --err:#b91c1c }
    body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:#f6f7fb; color:var(--text) }
    .wrap{ max-width:420px; margin:10vh auto; background:var(--panel); border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.08); padding:22px }
    h1{ margin:0 0 6px; font-size:22px; }
    p{ margin:0 0 14px; color:#475569 }
    .row{ display:flex; flex-direction:column; gap:10px; }
    input{ padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; font-size:15px }
    button{ padding:10px 14px; border:none; border-radius:10px; background:var(--brand); color:#fff; font-weight:700; cursor:pointer }
    button:disabled{ opacity:.6; cursor:not-allowed }
    .msg{ margin-top:12px; font-size:14px }
    .ok{ color:var(--ok) } .err{ color:var(--err) }
    .muted{ font-size:12px; color:#64748b; margin-top:10px }
    .brand{ display:flex; align-items:center; gap:10px; margin-bottom:10px }
    .brand img{ height:40px; border-radius:8px; box-shadow:0 6px 22px rgba(0,0,0,.18) }
    .center{ text-align:center; }
    a{ color:#0ea5e9; text-decoration:none }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <img src="logo-salvi.png" alt="Salvi" />
      <h1>R√©initialiser le mot de passe</h1>
    </div>
    <p id="state">V√©rification du lien‚Ä¶</p>

    <div id="form" style="display:none">
      <div class="row">
        <input id="pwd1" type="password" placeholder="Nouveau mot de passe (min 8 caract√®res)" />
        <input id="pwd2" type="password" placeholder="Confirmer le nouveau mot de passe" />
        <button id="btnSave">Mettre √† jour le mot de passe</button>
        <div id="msg" class="msg"></div>
      </div>
      <p class="muted">Astuce : choisis une phrase secr√®te facile √† retenir üí°</p>
    </div>

    <div id="done" class="center" style="display:none">
      <p class="ok">‚úÖ Mot de passe mis √† jour.</p>
      <p><a href="./">Retour √† l‚Äôapplication</a></p>
    </div>

    <div id="error" class="center" style="display:none">
      <p class="err">‚ùå Lien invalide ou expir√©.</p>
      <p>Reviens sur l‚Äôapplication et demande un nouveau lien <br />(‚ÄúMot de passe oubli√© ?‚Äù).</p>
      <p class="muted">Le lien est √† usage unique et expire rapidement.</p>
    </div>
  </div>

<script>
/* ========= 0) CONFIG SUPABASE ========= */
const SUPABASE_URL = "https://svexvxvgexvavtnfnkwh.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2ZXh2eHZnZXh2YXZ0bmZua3doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NTIxMTIsImV4cCI6MjA3MzUyODExMn0.Ux4HX99qzVGLKC35dfuizbZq-OS-x98BpamYffoDpUk";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true, autoRefreshToken: true }
});

/* ========= 1) OUTILS UI ========= */
const $ = (id) => document.getElementById(id);
const ui = {
  show: (id) => ($(id).style.display = 'block'),
  hide: (id) => ($(id).style.display = 'none'),
  text: (id, s) => ($(id).textContent = s),
  msg:  (s, ok=false) => { const el = $('msg'); el.className = 'msg ' + (ok?'ok':'err'); el.textContent = s; }
};

/* ========= 2) √âTABLIR LA SESSION DE R√âCUP√âRATION =========
   On g√®re:
   - Les liens avec #access_token (classique) -> supabase-js le prend en charge auto
   - Les liens avec ?code=... (PKCE) -> on appelle exchangeCodeForSession()
============================================================ */
async function ensureRecoverySession() {
  // 2a) Si query ?code=..., on √©change pour une session
  const url = new URL(window.location.href);
  const code = url.searchParams.get('code');

  if (code) {
    const { data, error } = await sb.auth.exchangeCodeForSession(code);
    if (error) {
      console.error('exchangeCodeForSession error:', error);
      return null;
    }
  }

  // 2b) V√©rifie qu'on a bien une session active (apr√®s √©change OU via hash)
  const { data: { session }, error } = await sb.auth.getSession();
  if (error) { console.error('getSession error:', error); }
  return session;
}

/* ========= 3) BOOTSTRAP ========= */
async function bootstrap() {
  try {
    ui.text('state', 'Validation du lien‚Ä¶');
    const session = await ensureRecoverySession();

    if (!session) {
      // Pas de session => lien invalide/expir√© ou d√©j√† utilis√©
      ui.hide('state'); ui.show('error');
      return;
    }

    // Session OK -> affiche le formulaire
    ui.text('state', 'Lien valid√© ‚úÖ');
    setTimeout(()=>{ ui.hide('state'); ui.show('form'); }, 400);

  } catch (e) {
    console.error(e);
    ui.hide('state'); ui.show('error');
  }
}

/* ========= 4) SOUMISSION DU NOUVEAU MOT DE PASSE ========= */
$('btnSave').addEventListener('click', async () => {
  const p1 = $('pwd1').value.trim();
  const p2 = $('pwd2').value.trim();

  if (p1.length < 8) { ui.msg("Le mot de passe doit faire au moins 8 caract√®res."); return; }
  if (p1 !== p2)     { ui.msg("Les mots de passe ne correspondent pas."); return; }

  $('btnSave').disabled = true;
  ui.msg('Mise √† jour en cours‚Ä¶', true);

  const { data, error } = await sb.auth.updateUser({ password: p1 });
  $('btnSave').disabled = false;

  if (error) {
    console.error(error);
    ui.msg("Erreur : " + (error.message || error));
    return;
  }

  ui.hide('form'); ui.show('done');
});

/* LANCE */
bootstrap();
</script>
</body>
</html>
